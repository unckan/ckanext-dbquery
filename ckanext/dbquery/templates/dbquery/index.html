{% extends "admin/base.html" %}

{% block title %}DBQuery Admin{% endblock %}

{% block primary_content_inner %}
  <h1>CKAN DB Query</h1>
  
  <form method="post" class="form">
    <div class="row">
      <div class="col-md-8">
        <div class="form-group">
          <label for="query">Buscar texto:</label>
          <input type="text" class="form-control" id="query" name="query" 
                 placeholder="Ingrese texto para buscar en la base de datos..." 
                 value="{{ request.form.get('query', '') }}">
        </div>
      </div>
      <div class="col-md-4">
        <div class="form-group">
          <label for="object_type">Tipo de objeto (opcional):</label>
          <select class="form-control" id="object_type" name="object_type">
            {% for option in object_types %}
            <option value="{{ option.value }}" 
                    {% if request.form.get('object_type') == option.value %}selected{% endif %}>
              {{ option.text }}
            </option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
    <button class="btn btn-primary" type="submit">Buscar</button>
  </form>
  
  {% if results %}
    <div class="results-section">
      <h3 class="text-primary">Resultados de la b√∫squeda</h3>
      
      {% if results.objects %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Objetos encontrados ({{ results.objects|length }})</h4>
          </div>
          <div class="panel-body">
            <table class="table table-striped table-bordered">
              <thead>
                <tr>
                  <th>Tipo</th>
                  <th>Nombre</th>
                  <th>ID</th>
                  <th>Detalles</th>
                </tr>
              </thead>
              <tbody>
                {% for obj in results.objects %}
                <tr>
                  <td>{{ obj.type }}</td>
                  <td>{{ obj.display_name }}</td>
                  <td>{{ obj.id }}</td>
                  <td>
                    {% for key, value in obj.items() %}
                      {% if key not in ['id', 'type', 'display_name'] %}
                        <strong>{{ key }}:</strong> {{ value }}<br>
                      {% endif %}
                    {% endfor %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endif %}
      
      {% if results.tables %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Tablas encontradas ({{ results.tables|length }})</h4>
          </div>
          <div class="panel-body">
            <ul>
              {% for table in results.tables %}
                <li>{{ table }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
      
      {% if results.columns %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Columnas encontradas ({{ results.columns|length }})</h4>
          </div>
          <div class="panel-body">
            <ul>
              {% for col in results.columns %}
                <li>{{ col.table }}.{{ col.column }}</li>
              {% endfor %}
            </ul>
          </div>
        </div>
      {% endif %}
      
      {% if results.rows %}
        <div class="panel panel-default">
          <div class="panel-heading">
            <h4>Filas encontradas</h4>
          </div>
          <div class="panel-body">
            {% for row_match in results.rows %}
              <div class="table-match">
                <h5>{{ row_match.table }}.{{ row_match.column }}</h5>
                <table class="table table-striped table-bordered">
                  <thead>
                    <tr>
                      <th>{{ row_match.column }}</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for match in row_match.matches %}
                      <tr>
                        <td>{{ match[row_match.column] }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endfor %}
          </div>
        </div>
      {% endif %}
    </div>
  {% endif %}
{% endblock %}
